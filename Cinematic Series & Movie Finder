import React, { useState } from 'react';
import { Film, Tv, Sparkles, X, SlidersHorizontal } from 'lucide-react';

export default function MovieRecommendationApp() {
  const [filters, setFilters] = useState({
    genre: '',
    socialContext: '',
    language: '',
    contentType: '',
    maturityRating: ''
  });
  const [recommendations, setRecommendations] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showFilters, setShowFilters] = useState(true);
  const [previousTitles, setPreviousTitles] = useState([]);

  const getRecommendations = async () => {
    setLoading(true);
    
    try {
      // Build the prompt based on selected filters
      let filterDescription = "Recommend 5 DIFFERENT ";
      
      if (filters.contentType === 'movie') {
        filterDescription += "movies";
      } else if (filters.contentType === 'series') {
        filterDescription += "TV series";
      } else {
        filterDescription += "movies or TV series";
      }
      
      const filterParts = [];
      if (filters.genre) filterParts.push(`Genre: ${filters.genre}`);
      if (filters.socialContext) filterParts.push(`Viewing context: ${filters.socialContext}`);
      if (filters.language) filterParts.push(`Original language: ${filters.language}`);
      if (filters.maturityRating) filterParts.push(`Maturity rating: ${filters.maturityRating}`);
      
      const filtersText = filterParts.length > 0 
        ? ` that match these preferences:\n${filterParts.join('\n')}` 
        : " from a wide variety of genres, years, and styles";

      // Add exclusion list if there are previous recommendations
      const exclusionText = previousTitles.length > 0 
        ? `\n\nCRITICAL: You have already recommended these titles: ${previousTitles.join(', ')}. DO NOT include any of these titles again. Provide 5 completely NEW and DIFFERENT recommendations that you have NOT suggested before. Dig deeper into the catalog and find hidden gems or less obvious choices.`
        : '\n\nProvide a diverse mix of popular and hidden gem titles from different genres and time periods.';

      // Add timestamp and random seed for uniqueness
      const timestamp = Date.now();
      const randomSeed = Math.random().toString(36).substring(7);

      const prompt = `${filterDescription}${filtersText}${exclusionText}

Request ID: ${timestamp}-${randomSeed}

IMPORTANT: For this specific request, provide completely unique recommendations. Do not repeat the same popular titles. Mix well-known classics with hidden gems, recent releases with timeless favorites, and ensure maximum variety across genres, decades, and styles.

For each recommendation, provide the streaming platform(s) where it's currently available (Netflix, Hulu, Disney+, Amazon Prime, HBO Max, Paramount+, Apple TV+, etc.).

Return ONLY valid JSON (no markdown, no backticks) in this exact format:
{
  "recommendations": [
    {
      "title": "Title",
      "type": "movie or series",
      "year": 2020,
      "genre": "Genre",
      "rating": "PG-13 or TV-14 etc",
      "runtime": "120 min or 3 seasons",
      "description": "One compelling sentence about why someone would love this",
      "streamingPlatforms": ["Platform1", "Platform2"],
      "language": "English"
    }
  ]
}

Ensure variety in your recommendations and include titles from different streaming platforms. Make each recommendation unique and avoid repeating any titles you've already suggested.`;

      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 2000,
          messages: [
            { role: "user", content: prompt }
          ],
        })
      });

      const data = await response.json();
      const aiText = data.content[0].text;
      const cleanText = aiText.replace(/```json\n?|```\n?/g, '').trim();
      const aiData = JSON.parse(cleanText);

      const newRecommendations = aiData.recommendations || [];
      setRecommendations(newRecommendations);
      
      // Add new titles to the exclusion list
      const newTitles = newRecommendations.map(rec => rec.title);
      setPreviousTitles(prev => [...prev, ...newTitles]);
      
    } catch (error) {
      console.error('Error getting recommendations:', error);
      alert('Failed to get recommendations. Please try again.');
      setRecommendations([]);
    } finally {
      setLoading(false);
      setShowFilters(false);
    }
  };

  const clearFilters = () => {
    setFilters({
      genre: '',
      socialContext: '',
      language: '',
      contentType: '',
      maturityRating: ''
    });
    setRecommendations([]);
    setPreviousTitles([]);
    setShowFilters(true);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-red-50">
      {/* Header */}
      <div className="bg-white/80 backdrop-blur-sm border-b border-orange-200 px-6 py-4 shadow-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Film className="w-8 h-8 text-orange-600" />
            <h1 className="text-2xl font-bold text-orange-900">Cinematic</h1>
          </div>
          <button
            onClick={() => setShowFilters(!showFilters)}
            className="flex items-center gap-2 px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-800 rounded-lg transition-colors"
          >
            <SlidersHorizontal className="w-4 h-4" />
            {showFilters ? 'Hide' : 'Show'} Filters
          </button>
        </div>
      </div>

      <div className="max-w-7xl mx-auto p-6">
        {/* Filters Panel */}
        {showFilters && (
          <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 mb-6 border border-orange-200 shadow-lg">
            <h2 className="text-xl font-semibold mb-6 text-orange-900">What are you in the mood for?</h2>
            
            <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
              {/* Genre */}
              <div>
                <label className="block text-sm text-orange-800 font-medium mb-2">Genre</label>
                <select
                  value={filters.genre}
                  onChange={(e) => setFilters({...filters, genre: e.target.value})}
                  className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5 text-orange-900 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent"
                >
                  <option value="">Any</option>
                  <option value="Action">Action</option>
                  <option value="Animation">Animation</option>
                  <option value="Comedy">Comedy</option>
                  <option value="Crime">Crime</option>
                  <option value="Documentary">Documentary</option>
                  <option value="Drama">Drama</option>
                  <option value="Fantasy">Fantasy</option>
                  <option value="Horror">Horror</option>
                  <option value="Romance">Romance</option>
                  <option value="Sci-Fi">Sci-Fi</option>
                  <option value="Thriller">Thriller</option>
                </select>
              </div>

              {/* Social Context */}
              <div>
                <label className="block text-sm text-orange-800 font-medium mb-2">Social Context</label>
                <select
                  value={filters.socialContext}
                  onChange={(e) => setFilters({...filters, socialContext: e.target.value})}
                  className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5 text-orange-900 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent"
                >
                  <option value="">Any</option>
                  <option value="Solo watch">Solo watch</option>
                  <option value="Date night">Date night</option>
                  <option value="Group watch">Group watch</option>
                  <option value="Family-safe">Family-safe</option>
                  <option value="Conversation-starter">Conversation-starter</option>
                  <option value="Background viewing">Background viewing</option>
                </select>
              </div>

              {/* Language */}
              <div>
                <label className="block text-sm text-orange-800 font-medium mb-2">Language</label>
                <select
                  value={filters.language}
                  onChange={(e) => setFilters({...filters, language: e.target.value})}
                  className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5 text-orange-900 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent"
                >
                  <option value="">Any</option>
                  <option value="English">English</option>
                  <option value="Spanish">Spanish</option>
                  <option value="Korean">Korean</option>
                  <option value="Japanese">Japanese</option>
                  <option value="French">French</option>
                  <option value="German">German</option>
                </select>
              </div>

              {/* Content Type */}
              <div>
                <label className="block text-sm text-orange-800 font-medium mb-2">Content Type</label>
                <select
                  value={filters.contentType}
                  onChange={(e) => setFilters({...filters, contentType: e.target.value})}
                  className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5 text-orange-900 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent"
                >
                  <option value="">Any</option>
                  <option value="movie">Movies</option>
                  <option value="series">Series</option>
                </select>
              </div>
            </div>

            <div className="grid md:grid-cols-4 gap-6 mb-6">
              {/* Maturity Rating */}
              <div>
                <label className="block text-sm text-orange-800 font-medium mb-2">Maturity Rating</label>
                <select
                  value={filters.maturityRating}
                  onChange={(e) => setFilters({...filters, maturityRating: e.target.value})}
                  className="w-full bg-white border-2 border-orange-200 rounded-lg px-4 py-2.5 text-orange-900 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent"
                >
                  <option value="">Any</option>
                  <option value="PG">PG</option>
                  <option value="TV-PG">TV-PG</option>
                  <option value="PG-13">PG-13</option>
                  <option value="TV-14">TV-14</option>
                  <option value="R">R</option>
                  <option value="TV-MA">TV-MA</option>
                </select>
              </div>
            </div>

            <div className="flex gap-3">
              <button
                onClick={getRecommendations}
                disabled={loading}
                className="flex-1 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 disabled:from-gray-300 disabled:to-gray-400 text-white px-6 py-3 rounded-lg font-medium transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2"
              >
                {loading ? (
                  <>
                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    Finding perfect matches...
                  </>
                ) : (
                  <>
                    <Sparkles className="w-5 h-5" />
                    Get Recommendations
                  </>
                )}
              </button>
              <button
                onClick={clearFilters}
                className="px-6 py-3 bg-orange-100 hover:bg-orange-200 text-orange-800 rounded-lg transition-colors flex items-center gap-2 font-medium"
              >
                <X className="w-5 h-5" />
                Clear
              </button>
            </div>
          </div>
        )}

        {/* Results */}
        {recommendations.length > 0 ? (
          <div>
            <h2 className="text-2xl font-bold mb-6 text-orange-900">Recommended for you</h2>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              {recommendations.map((item, idx) => (
                <div
                  key={idx}
                  className="bg-white/90 backdrop-blur-sm rounded-xl overflow-hidden border-2 border-orange-200 hover:border-orange-400 transition-all hover:scale-105 hover:shadow-xl"
                >
                  {/* Placeholder for poster */}
                  <div className="aspect-video bg-gradient-to-br from-orange-100 via-amber-100 to-red-100 flex items-center justify-center">
                    {item.type === 'movie' ? (
                      <Film className="w-16 h-16 text-orange-300" />
                    ) : (
                      <Tv className="w-16 h-16 text-orange-300" />
                    )}
                  </div>
                  
                  <div className="p-5">
                    <div className="flex items-start justify-between mb-2">
                      <h3 className="text-lg font-bold text-orange-900 flex-1">{item.title}</h3>
                      <span className="text-xs bg-orange-100 px-2 py-1 rounded text-orange-800 font-medium ml-2">
                        {item.rating}
                      </span>
                    </div>
                    
                    <div className="flex gap-2 mb-3 text-xs text-orange-700">
                      <span>{item.year}</span>
                      <span>•</span>
                      <span>{item.genre}</span>
                      <span>•</span>
                      <span>{item.runtime}</span>
                    </div>
                    
                    <p className="text-sm text-orange-800 leading-relaxed mb-4">
                      {item.description}
                    </p>
                    
                    {/* Streaming Platforms */}
                    <div className="mb-3">
                      <p className="text-xs text-orange-700 font-semibold mb-2">Available on:</p>
                      <div className="flex flex-wrap gap-2">
                        {it
